name: CI - Quality Gates

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  quality-checks:
    name: Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: TypeScript Check
        run: npm run typecheck

      - name: Lint Check
        run: npm run lint

      - name: Run Tests
        run: npm run test

      - name: Build
        run: npm run build

  e2e-tests:
    name: E2E Tests (Playwright)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install chromium --with-deps

      - name: Run E2E Tests
        run: npm run test:e2e

      - name: Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

  sins-check:
    name: Sins Check (Code Quality)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # =========================================================================
      # Sin 0: Switch Statements (Architecture Rule - Use Mapped Object Literals)
      # =========================================================================
      - name: "Sin Check: No switch statements (use Mapped Object Literals)"
        run: |
          echo "üìã Checking for switch statements..."
          if grep -rE "^\s*switch\s*\(" src --include="*.ts" --include="*.tsx" 2>/dev/null; then
            echo "‚ùå FOUND: switch statements. Use Mapped Object Literals or Strategy Pattern instead."
            exit 1
          fi
          echo "‚úÖ No switch statements found."

      # =========================================================================
      # Sin 1: Ignore Directives
      # =========================================================================
      - name: "Sin Check: No ignore directives"
        run: |
          echo "üìã Checking for ignore directives..."
          if grep -rE "eslint-disable|@ts-ignore|@ts-nocheck|@ts-expect-error|biome-ignore" src 2>/dev/null; then
            echo "‚ùå FOUND: Ignore directives. Please remove them."
            exit 1
          fi
          echo "‚úÖ No ignore directives found."

      # =========================================================================
      # Sin 2: Empty Catch Blocks
      # =========================================================================
      - name: "Sin Check: No empty catch blocks"
        run: |
          echo "üìã Checking for empty catch blocks..."
          if grep -rE "catch\s*\([^)]*\)\s*\{\s*\}" src 2>/dev/null; then
            echo "‚ùå FOUND: Empty catch blocks. Catches must handle errors."
            exit 1
          fi
          echo "‚úÖ No empty catch blocks found."

      # =========================================================================
      # Sin 3: Any Type Usage
      # =========================================================================
      - name: "Sin Check: No 'any' type usage"
        run: |
          echo "üìã Checking for 'any' type usage..."
          if grep -rE ":\s*any\b|<any>|as\s+any" src --include="*.ts" --include="*.tsx" 2>/dev/null; then
            echo "‚ùå FOUND: 'any' type usage. Use proper types instead."
            exit 1
          fi
          echo "‚úÖ No 'any' type usage found."

      # =========================================================================
      # Sin 4: Mutable Declarations (let/var)
      # =========================================================================
      - name: "Sin Check: No let/var declarations"
        run: |
          echo "üìã Checking for 'let' and 'var' declarations..."
          if grep -rE "^\s*(let|var)\s+" src --include="*.ts" --include="*.tsx" 2>/dev/null; then
            echo "‚ùå FOUND: Mutable declarations. Use const instead."
            exit 1
          fi
          echo "‚úÖ No mutable declarations found."

      # =========================================================================
      # Sin 5: Console Statements
      # =========================================================================
      - name: "Sin Check: No console statements"
        run: |
          echo "üìã Checking for console statements..."
          if grep -rE "console\.(log|warn|error|info|debug)" src --include="*.ts" --include="*.tsx" 2>/dev/null; then
            echo "‚ùå FOUND: Console statements. Use proper logging instead."
            exit 1
          fi
          echo "‚úÖ No console statements found."

      # =========================================================================
      # Sin 6: Large Files (>100 lines) - Excludes test files
      # =========================================================================
      - name: "Sin Check: No large files (>100 lines)"
        run: |
          echo "üìã Checking for large files (>100 lines, excluding tests)..."
          LIMIT=100
          LARGE_FILES=$(find src -name "*.ts" -o -name "*.tsx" 2>/dev/null | grep -v "\.test\." | xargs wc -l 2>/dev/null | awk -v limit=$LIMIT '$1 > limit && $2 != "total" {print $2 ": " $1 " lines"}')
          
          if [ -n "$LARGE_FILES" ]; then
            echo ""
            echo "‚ö†Ô∏è  WARNING: The following files exceed $LIMIT lines:"
            echo "$LARGE_FILES"
            echo ""
            echo "‚ùå STRICT MODE: Exiting due to large files."
            exit 1
          fi
          echo "‚úÖ No large files found."

      # =========================================================================
      # Sin 7: Untested Files (checks top-level modules, not split submodules)
      # =========================================================================
      - name: "Sin Check: All game files have tests"
        run: |
          echo "üìã Checking for files without test suites..."
          
          UNTESTED_FILES=""
          GAME_DIR="src/game"
          
          # Only check top-level files, not submodule split files
          # Submodules (in types/, card/, state/, scoring/) are tested via barrel exports
          if [ -d "$GAME_DIR" ]; then
            for file in $(find "$GAME_DIR" -maxdepth 1 -name "*.ts" ! -name "*.test.ts" ! -name "index.ts" ! -name "types.ts" 2>/dev/null); do
              # Skip barrel re-export files (they just re-export from submodules)
              if grep -qE "^export \* from" "$file" 2>/dev/null; then
                continue
              fi
              
              if grep -qE "^export (const|function)" "$file" 2>/dev/null; then
                dir=$(dirname "$file")
                basename=$(basename "$file" .ts)
                test_file="$dir/$basename.test.ts"
                
                if [ ! -f "$test_file" ]; then
                  UNTESTED_FILES="$UNTESTED_FILES$file\n"
                fi
              fi
            done
          fi
          
          if [ -n "$UNTESTED_FILES" ]; then
            echo ""
            echo "‚ö†Ô∏è  WARNING: The following files have functions but no test suite:"
            echo -e "$UNTESTED_FILES"
            echo "Expected: <file>.test.ts in same directory"
            echo ""
            echo "‚ùå STRICT MODE: Exiting due to untested files."
            exit 1
          fi
          echo "‚úÖ All function files have test suites."

      # =========================================================================
      # All Checks Passed
      # =========================================================================
      - name: "‚úÖ All Sins Checks Passed"
        run: |
          echo ""
          echo "üéâ No sins found! Code is pure."
